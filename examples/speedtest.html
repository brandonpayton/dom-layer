<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<style type="text/css">
  p {
    font: 12px/16px Arial;
    margin: 10px 10px 15px;
  }

  button {
    font: bold 14px/14px Arial;
    margin-left: 10px;
  }

  #grid {
    margin: 10px;
  }

  .box-view {
    width: 20px; height: 20px;
    float: left;
    position: relative;
    margin: 8px;
  }

  .box {
    border-radius: 100px;
    width: 20px; height: 10px;
    padding: 5px 0;
    color: #fff;
    font: 10px/10px Arial;
    text-align: center;
    position: absolute;
  }
</style>
</head>
<body>
<p>
  This is a fork of <a href="http://jsfiddle.net/jashkenas/CGSd5/" target="_top">jashkenas's Ember/Backbone</a> with some stats around.
</p>

<button onclick="start()">Start</button> <button onclick="reset()">Stop</button>
<p id="timing">&nbsp;</p>

<div id="grid"></div>

<script src="../dist/dom-layer.js"></script>
<script type="text/javascript">

var Tree = domLayer.Tree;
var Tag = domLayer.Tag;
var Text = domLayer.Text;
var N = 500;

function Animation() {
  this.count = 0 ;
}

Animation.prototype.getStyle = function() {
  return {
    top: (Math.sin(this.count / 10) * 10) + "px",
    left: (Math.cos(this.count / 10) * 10) + "px",
    background: "rgb(0,0," + (this.count % 255) +")"
  };
}

Animation.prototype.createBoxes = function() {
  var boxes = [];
  for(var i = 0 ; i < N; i++) {
    boxes.push(
      new Tag("div", { attrs: {"class": "box-view"} }, [
        new Tag("div", { attrs: {"class": "box", style: this.getStyle() } }, [
          new Text(this.count % 100 + '')
        ])
      ])
    );
  }
  return boxes;
}

Animation.prototype.update = function() {
  this.count++;
  return new Tag("div", {}, this.createBoxes());
}

var tree = new Tree();

function start() {
  var animation = new Animation();
  var id = tree.mount("#grid", animation.update.bind(animation));
  startClock();
  benchmarkLoop(function() { tree.update(id); });
}

// ------ Benchmark stuff bellow ---------

var timeout = null;
var totalTime = null;
var loopCount = null;
var startDate = null;

function reset() {
  document.getElementById('grid').innerHTML = '';
  document.getElementById('timing').innerHTML = '&nbsp;';
  clearTimeout(timeout);
}

function startClock() {
  loopCount = 0;
  totalTime = 0;
  startDate = Date.now();
}

function benchmarkLoop(fn) {
  totalTime += Date.now() - startDate;
  startDate = Date.now();
  fn();
  loopCount++;
  if (loopCount % 20 === 0) {
    document.getElementById('timing').textContent = 'Performed ' + loopCount + ' iterations in ' + totalTime + ' ms (average ' + (totalTime / loopCount).toFixed(2) + ' ms per loop).';
  }
  timeout = setTimeout(function () { benchmarkLoop(fn) }, 0);
}
</script>
</body>
